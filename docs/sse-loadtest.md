# การทำ Load Test สำหรับ Server-Sent Events (SSE)

การทดสอบประสิทธิภาพ (Load Testing) ของ Server-Sent Events (SSE) endpoint มีความท้าทายเฉพาะตัวที่แตกต่างจากการทดสอบ API แบบ request-response ทั่วไป เนื่องจาก SSE เป็นการเชื่อมต่อแบบ persistent ที่เปิดค้างไว้ ทำให้เราต้องพิจารณาปัจจัยหลายด้านเพื่อให้การทดสอบสะท้อนการใช้งานจริงและครอบคลุมที่สุด

## ปัจจัยสำคัญที่ต้องพิจารณา

SSE Endpoint มีความแตกต่างกับ endpoint ปกติอยู่บ้าง เนื่องจากเป็นการเชื่อมต่อแบบสตรีม คือจะจองงทรัพยากรบนเซิร์ฟเวอร์ (เช่น หน่วยความจำ, file descriptors) ตลอดเวลาที่ยังเชื่อมต่อค้างไว้อยู่ นอกจากการวัดผลเป็น Transactions Per Second (TPS) เหมือน API ทั่วไปแล้ว แต่จะวัด **อัตราการส่ง event** ทั้งหมดจากเซิร์ฟเวอร์ไปยัง client ที่เชื่อมต่ออยู่ด้วย (หน่วยอาจเป็น Events Per Second หรือ Messages Per Second)

ผู้ใช้แต่ละคนอาจเชื่อมต่อ SSE เป็นระยะเวลาที่แตกต่างกัน (บางคนไม่กี่นาที บางคนอาจเป็นชั่วโมง) การเชื่อมต่อที่ค้างอยู่นานๆ มีผลต่อการใช้ทรัพยากรสะสมของเซิร์ฟเวอร์ ในโลกความเป็นจริง จะมีผู้ใช้ใหม่เชื่อมต่อเข้ามาและผู้ใช้เดิมตัดการเชื่อมต่อออกไปอยู่เสมอ (เรียกว่า "Churn")  

การทดสอบควรรจำลองระยะเวลาการเชื่อมต่อที่หลากหลายตามพฤติกรรมผู้ใช้จริง เพื่อประเมินผลกระทบในระยะยาว สามารถสรุปเบื้องต้นไว้ได้ดังนี้

- จำนวนผู้ใช้สูงสุดที่เชื่อมต่อพร้อมกัน (Peak Concurrent Connections)
- อัตราการส่ง Event (SSE Event Rate/Throughput)
- อัตราการส่งที่สูงจะทดสอบขีดจำกัดของ CPU และ Network I/O ของเซิร์ฟเวอร์โดยตรง
- ระยะเวลาของการเชื่อมต่อ (Connection Lifetime)
- อัตราการเข้า-ออกของการเชื่อมต่อ (Connection Churn Rate)

## ปัจจัยเพิ่มเติมที่ควรพิจารณาในการออกแบบและแก้ไข software

นอกเหนือจากปัจจัยหลักแล้ว ยังมีรายละเอียดอื่นๆ ที่อาจส่งผลต่อประสิทธิภาพและควรนำมาพิจารณาในการทดสอบด้วย

- ขนาดของข้อมูล Event (Event Payload Size) ขนาดของข้อมูลที่ส่งในแต่ละ event ส่งผลโดยตรงต่อการใช้งาน Bandwidth และหน่วยความจำทั้งฝั่งเซิร์ฟเวอร์และ client ควรใช้ขนาดที่ใกล้เคียงกับข้อมูลจริง  

- การติดตามทรัพยากรเซิร์ฟเวอร์ (Server Resource Monitoring) **จำเป็นอย่างยิ่ง** ที่จะต้องติดตามการใช้ CPU, Memory, Network I/O, และจำนวน File Descriptors ที่เซิร์ฟเวอร์ใช้งานระหว่างการทดสอบ เพื่อระบุปัญหาคอขวด (bottleneck) ได้อย่างแม่นยำ
- พฤติกรรมฝั่ง Client (Client-Side Behavior) แม้จะเน้นทดสอบฝั่งเซิร์ฟเวอร์เป็นหลัก แต่การที่ client ต้องประมวลผล event ที่ได้รับอย่างหนักหน่วง ก็อาจส่งผลกระทบต่อประสิทธิภาพโดยรวมได้
- สภาพเครือข่าย (Network Conditions) หากผู้ใช้อยู่ในสภาพเครือข่ายที่หลากหลาย (เช่น 3G, Wi-Fi ไม่เสถียร) การจำลองความหน่วง (latency) และข้อจำกัดด้าน bandwidth (ถ้าเครื่องมือทดสอบรองรับ) จะช่วยให้ผลลัพธ์สมจริงยิ่งขึ้น
- การจัดการข้อผิดพลาดและการเชื่อมต่อใหม่ (Error Handling and Reconnection) ทดสอบว่าระบบ (ทั้ง client และ server) จัดการกับการเชื่อมต่อที่หลุดหรือเกิดข้อผิดพลาดอย่างไร มีกลไกการเชื่อมต่อใหม่ (reconnection) ที่เหมาะสมและทำงานได้ถูกต้องหรือไม่

## แนวทางการออกแบบ Load Test (Design Approach)

เพื่อให้การทดสอบมีประสิทธิภาพ ควรวางแผนและออกแบบขั้นตอนดังนี้

1. กำหนดเป้าหมายของการทดสอบ (Define Objectives)  
ตั้งคำถามให้ชัดเจนว่าต้องการอะไรจากการทดสอบครั้งนี้ เช่น
    - ต้องการหาขีดจำกัดสูงสุด (Maximum Capacity) ที่ระบบรับได้?
    - ต้องการยืนยันว่าระบบทำงานได้เสถียร (Stability) ภายใต้โหลดที่คาดการณ์ (Expected Load)?
    - ต้องการหาคอขวด (Bottlenecks) ของระบบ?

2. ระบุสถานการณ์ทดสอบหลัก (Key Scenarios)  
ออกแบบรูปแบบการทดสอบ (Test Patterns) ที่หลากหลายเพื่อจำลองสถานการณ์ต่างๆ เช่น
    - Ramp-up ทดสอบโดยค่อยๆ เพิ่มจำนวนผู้ใช้ (connections) ขึ้นไปจนถึงเป้าหมาย เพื่อดูว่าระบบตอบสนองต่อโหลดที่เพิ่มขึ้นอย่างไร
    - Peak Load ทดสอบโดยคงจำนวนผู้ใช้และอัตราการส่ง event สูงสุดไว้เป็นระยะเวลาหนึ่ง (เช่น 15-30 นาที) เพื่อประเมินความเสถียรภายใต้โหลดสูงสุด
    - Stress Test ทดสอบโดยใช้โหลดที่สูงกว่า Peak Load ที่คาดการณ์ เพื่อหาจุดที่ระบบเริ่มทำงานผิดพลาดหรือประสิทธิภาพตกลงอย่างมีนัยสำคัญ
    - Soak Test (Endurance Test) ทดสอบโดยใช้โหลดปานกลาง (เช่น 70-80% ของ Peak) เป็นระยะเวลานาน (เช่น หลายชั่วโมง) เพื่อตรวจสอบปัญหา เช่น memory leak หรือ resource exhaustion ในระยะยาว
    - Churn Test ทดสอบโดยจำลองสถานการณ์ที่มีผู้ใช้เชื่อมต่อเข้ามาและตัดการเชื่อมต่อออกไปอย่างต่อเนื่อง ควบคู่ไปกับการมีผู้ใช้จำนวนหนึ่งเชื่อมต่อค้างอยู่

3. เลือกเครื่องมือทดสอบ (Choose Tools) เลือกใช้เครื่องมือ Load Testing ที่รองรับโปรโตคอล SSE ได้ดี ตัวอย่างเช่น
    - k6 เครื่องมือยอดนิยม เขียนสคริปต์ด้วย JavaScript มีความยืดหยุ่นสูง แต่ต้องอาศัย Plugin k6-sse เพิ่มเติม

4. กำหนดตัวชี้วัด (Define Metrics) กำหนดว่าจะวัดผลอะไรบ้าง ทั้งฝั่งเซิร์ฟเวอร์และฝั่ง client ที่ใช้ทดสอบ:
    - ฝั่งเซิร์ฟเวอร์ CPU Usage, Memory Usage, Network I/O, จำนวน Open File Descriptors, อัตราข้อผิดพลาด (Error Rate จาก logs)
    - ฝั่ง Test Client จำนวน Concurrent Connections ที่สร้างได้สำเร็จ, ความหน่วงในการรับ Event (Event Latency - ถ้าวัดได้), อัตราข้อผิดพลาดในการเชื่อมต่อ (Connection Error Rate)

5. ดำเนินการทดสอบ วิเคราะห์ผล และปรับปรุง (Execute, Analyze, Iterate)
    - รันสถานการณ์ทดสอบตามที่ได้ออกแบบไว้
    - รวบรวมผลลัพธ์จากการทดสอบและข้อมูลการ Monitoring จากเซิร์ฟเวอร์
    - วิเคราะห์ผลเพื่อหาข้อจำกัด, คอขวด, หรือปัญหาอื่นๆ
    - นำผลการวิเคราะห์ไปปรับปรุงแก้ไขระบบหรือ Configuration แล้วทำการทดสอบซ้ำ ซึ่งเป็นกระบวนการที่ต้องทำซ้ำๆ (Iterative process)

สรุปแล้ว การทดสอบประสิทธิภาพของ SSE ที่ดีนั้นต้องการการวางแผนและการออกแบบที่รอบคอบ การเลือกใช้เครื่องมือที่เหมาะสม รวมถึงการติดตามและวิเคราะห์ผลอย่างละเอียด เพื่อให้มั่นใจว่าระบบ SSE ของเรามีความเสถียรและสามารถรองรับการใช้งานจริงได้อย่างมีประสิทธิภาพ
